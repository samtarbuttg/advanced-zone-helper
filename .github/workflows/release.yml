name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create PCM package structure
        run: |
          mkdir -p package/plugins/advanced-zone-helper
          mkdir -p package/resources
          
          # Copy plugin files to plugins directory
          cp zone_helper.py package/plugins/advanced-zone-helper/
          cp __init__.py package/plugins/advanced-zone-helper/
          cp -r src package/plugins/advanced-zone-helper/
          
          # Copy toolbar icon (24x24) to plugins directory
          cp icons/advanced_zone_helper.png package/plugins/advanced-zone-helper/
          
          # Create 64x64 icon for PCM (or copy if already correct size)
          cp icons/advanced_zone_helper.png package/resources/icon.png
          
          # Remove __pycache__ directories
          find package -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          
          # Remove test files
          rm -f package/plugins/advanced-zone-helper/test_*.py 2>/dev/null || true

      - name: Create metadata.json for package
        run: |
          cat > package/metadata.json << 'EOF'
          {
              "$schema": "https://go.kicad.org/pcm/schemas/v1",
              "name": "Advanced Zone Helper",
              "description": "Create zones from selected shapes, including ring zones between nested outlines",
              "description_full": "A KiCad plugin that creates zones from selected graphic shapes.\n\nFeatures:\n- Automatically detects closed loops from selected lines, arcs, and circles\n- Creates ring zones between nested outlines (e.g., between two concentric circles)\n- Supports multi-hole zones (outer boundary with multiple inner cutouts)\n- Configure layer, net, priority, and clearance settings\n- Preview detected zones before creation\n\nUsage:\n1. Draw shapes that form closed loops\n2. Select the shapes\n3. Run the plugin from Tools â†’ External Plugins\n4. Select which zones to create and configure settings\n5. Click Create Zones",
              "identifier": "com-github-advanced-zone-helper",
              "type": "plugin",
              "author": {
                  "name": "Patrick",
                  "contact": {
                      "github": "https://github.com/${{ github.repository }}"
                  }
              },
              "license": "MIT",
              "resources": {
                  "homepage": "https://github.com/${{ github.repository }}"
              },
              "versions": [
                  {
                      "version": "${{ steps.version.outputs.VERSION }}",
                      "status": "stable",
                      "kicad_version": "7.0"
                  }
              ]
          }
          EOF

      - name: Create PCM ZIP package
        run: |
          cd package
          zip -r ../advanced-zone-helper-v${{ steps.version.outputs.VERSION }}-pcm.zip .

      - name: Create manual install ZIP
        run: |
          mkdir -p manual-install/advanced-zone-helper
          cp zone_helper.py manual-install/advanced-zone-helper/
          cp __init__.py manual-install/advanced-zone-helper/
          cp -r src manual-install/advanced-zone-helper/
          cp -r icons manual-install/advanced-zone-helper/
          find manual-install -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          rm -f manual-install/advanced-zone-helper/test_*.py 2>/dev/null || true
          cd manual-install
          zip -r ../advanced-zone-helper-v${{ steps.version.outputs.VERSION }}.zip .

      - name: Calculate SHA256
        id: sha256
        run: |
          echo "PCM_SHA256=$(sha256sum advanced-zone-helper-v${{ steps.version.outputs.VERSION }}-pcm.zip | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "MANUAL_SHA256=$(sha256sum advanced-zone-helper-v${{ steps.version.outputs.VERSION }}.zip | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            advanced-zone-helper-v${{ steps.version.outputs.VERSION }}-pcm.zip
            advanced-zone-helper-v${{ steps.version.outputs.VERSION }}.zip
          body: |
            ## Advanced Zone Helper v${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            #### Option 1: KiCad Plugin Manager (Recommended)
            1. Download `advanced-zone-helper-v${{ steps.version.outputs.VERSION }}-pcm.zip`
            2. In KiCad, go to **Plugin and Content Manager**
            3. Click **Install from File...** and select the downloaded ZIP
            
            #### Option 2: Manual Installation
            1. Download `advanced-zone-helper-v${{ steps.version.outputs.VERSION }}.zip`
            2. Extract to your KiCad plugins directory:
               - Windows: `%USERPROFILE%\Documents\KiCad\8.0\scripting\plugins\`
               - Linux: `~/.local/share/kicad/8.0/scripting/plugins/`
               - macOS: `~/Library/Preferences/kicad/8.0/scripting/plugins/`
            3. Restart KiCad
            
            ### Checksums
            - PCM package SHA256: `${{ steps.sha256.outputs.PCM_SHA256 }}`
            - Manual install SHA256: `${{ steps.sha256.outputs.MANUAL_SHA256 }}`
          generate_release_notes: true
